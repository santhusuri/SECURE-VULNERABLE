{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>{% block title %}E-Commerce{% endblock %}</title>
 <link rel="stylesheet" href="{% static 'css/styles.css' %}">
 <link rel="stylesheet" href="{% static 'css/main.css' %}">
 <link rel="stylesheet" href="{% static 'css/login.css' %}">
 {% block extra_css %}{% endblock %}
</head>
<body>

 <!-- ================= Navbar ================= -->
 <nav class="navbar">
   <div class="logo">
     <a href="{% url 'home' %}">MyShop</a>
   </div>

   <div class="nav-links">
    {% if user.is_authenticated %}
        <a href="{% url 'products:product_list' %}">Products</a>
        <a href="{% url 'cart:cart_view' %}">Cart</a>
        <a href="{% url 'orders:checkout' %}">Orders</a>
        <a href="{% url 'accounts:profile' %}">Profile</a>
        <a href="{% url 'accounts:logout' %}">Logout</a>
    {% else %}
        <a href="{% url 'accounts:login' %}">Login</a>
        <a href="{% url 'accounts:register' %}">Register</a>
    {% endif %}
</div>

   <!-- Toggle Panel -->
   <div class="toggle-panel">
     <span id="vuln-label" class="vuln-label"></span>
     <button id="toggle-mode-btn" class="toggle-btn"></button>
   </div>
 </nav>

 <!-- ================= Main Container ================= -->
 <div class="container">
   {% if messages %}
     <div class="messages">
       {% for message in messages %}
         <div class="alert alert-{{ message.tags }}">{{ message }}</div>
       {% endfor %}
     </div>
   {% endif %}

   {% if user.is_authenticated %}
   <form method="get" action="{% url 'products:product_search' %}" class="fixed-search-form">
     <input type="text" name="q" placeholder="Search products..." required class="fixed-search-input">
     <button type="submit" class="fixed-search-button">Search</button>
   </form>
   {% endif %}

   {% block content %}{% endblock %}
 </div>

 <!-- ================= Footer ================= -->
 <footer class="main-footer">
   <div class="footer-container">
     <div class="footer-column">
       <h3>Explore</h3>
       <ul>
         <li><a href="#about"><span>›</span> About</a></li>
         <li><a href="{% url 'products:product_list' %}"><span>›</span> Shop</a></li>
         <li><a href="#"><span>›</span> FAQ</a></li>
       </ul>
     </div>
     <div class="footer-column">
       <h3>Useful Links</h3>
       <ul>
         <li><a href="#"><span>›</span> Support</a></li>
         <li><a href="mailto:support@myshop.com"><span>›</span> Contact</a></li>
       </ul>
     </div>
   </div>

   <div class="footer-bottom">
     © {{ now|date:'Y' }} ShopSite
   </div>
 </footer>

 <!-- ================= Context Variables for JS ================= -->
<script>
  window.APP_CONTEXT = {
    mode: "{{ simulation_mode|default:'secure' }}",  // uses context processor
    csrfToken: "{{ csrf_token }}"
  };

  document.addEventListener("DOMContentLoaded", function() {
    const toggleBtn = document.getElementById('toggle-mode-btn');
    const vulnLabel = document.getElementById('vuln-label');
    let currentMode = window.APP_CONTEXT.mode;

    function updateUI(mode) {
      if (mode === "vulnerable") {
        toggleBtn.textContent = "Vulnerable Mode";
        toggleBtn.style.backgroundColor = "#dc3545"; // red
        toggleBtn.style.color = "#fff";
        vulnLabel.style.display = "inline-block";
        vulnLabel.textContent = "⚠ VULNERABLE LAB ACTIVE";
      } else {
        toggleBtn.textContent = "Secure Mode";
        toggleBtn.style.backgroundColor = "#4CAF50"; // green
        toggleBtn.style.color = "#fff";
        vulnLabel.style.display = "inline-block";
        vulnLabel.textContent = "✔ SECURE MODE";
      }
    }

    // Initialize UI
    updateUI(currentMode);

    // Click listener to toggle mode
    toggleBtn.addEventListener('click', function() {
      fetch('/accounts/toggle_mode/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': window.APP_CONTEXT.csrfToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
      })
      .then(response => response.json())
      .then(data => {
        if (data.mode) {
          currentMode = data.mode;
          updateUI(currentMode);
          alert(`Switched to ${currentMode.toUpperCase()} MODE!`);
          window.location.reload(); // reload to reflect changes globally
        }
      })
      .catch(() => {
        alert("⚠️ Error toggling mode!");
      });
    });
  });
</script>


 <!-- ================= JavaScript Files ================= -->
 <script src="{% static 'js/vuln_lab.js' %}"></script>

</body>
</html>
