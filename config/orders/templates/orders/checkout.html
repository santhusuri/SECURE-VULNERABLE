{% extends "base.html" %}
{% block title %}Secure Checkout{% endblock %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/orders.css' %}">
<link rel="stylesheet" href="{% static 'css/alerts.css' %}">
{% endblock %}

{% block content %}
{% include "includes/mode_banner.html" %}

<h2>ðŸ›’ Secure Checkout</h2>
<p>Your payment will be processed via <strong>Stripe</strong> with full validation.</p>

<table>
    {% for id, item in cart.items %}
    <tr>
        <td>{{ item.name }}</td>
        <td>{{ item.qty }}</td>
        <td>${{ item.price }}</td>
        <td>${{ item.subtotal }}</td>
    </tr>
    {% endfor %}
</table>

<p><strong>Total:</strong> ${{ total }}</p>

<!-- Stripe Payment Form -->
<form id="payment-form">
    <div id="card-element"><!--Stripe.js injects the Card Element--></div>
    <button id="submit" class="btn btn-checkout">Pay Securely</button>
</form>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
  const elements = stripe.elements();
  const card = elements.create("card");
  card.mount("#card-element");

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  const form = document.getElementById("payment-form");
  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    const { paymentIntent, error } = await stripe.confirmCardPayment("{{ client_secret }}", {
      payment_method: { card: card }
    });

    if (error) {
      alert(error.message);
    } else {
      // Call secure create_order to create DB order and get numeric order_id
      fetch("{% url 'orders:create_order' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ payment_intent_id: paymentIntent.id }),
      })
      .then(res => res.json())
      .then(data => {
        if (data.order_id) {
          // Redirect using integer order_id â†’ matches success/<int:order_id>/
          window.location.href = "{% url 'orders:order_success' 0 %}".replace("0", data.order_id);
        } else {
          alert("Order creation failed: " + (data.error || "Unknown error"));
        }
      });
    }
  });
</script>
{% endblock %}
