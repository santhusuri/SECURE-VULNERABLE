{% extends "base.html" %}
{% block title %}Secure Checkout{% endblock %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/orders.css' %}">
<link rel="stylesheet" href="{% static 'css/alerts.css' %}">
{% endblock %}

{% block content %}
{% include "includes/mode_banner.html" %}

<h2>ðŸ›’ Secure Checkout</h2>
<p>Your payment will be processed via <strong>Stripe</strong> with full validation.</p>

<table>
    {% for id, item in cart.items %}
    <tr>
        <td>{{ item.name }}</td>
        <td>{{ item.qty }}</td>
        <td>${{ item.price }}</td>
        <td>${{ item.subtotal }}</td>
    </tr>
    {% endfor %}
</table>

<p><strong>Total:</strong> ${{ total }}</p>

<!-- Stripe Payment Form -->
<form id="payment-form">
    <div id="card-element"><!--Stripe.js injects the Card Element--></div>
    <button id="submit" class="btn btn-checkout">Pay Securely</button>
</form>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
  const elements = stripe.elements();
  const card = elements.create("card");
  card.mount("#card-element");

  const form = document.getElementById("payment-form");
  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    const { paymentIntent, error } = await stripe.confirmCardPayment("{{ client_secret }}", {
      payment_method: { card: card }
    });
    if (error) {
      alert(error.message);
    } else {
      window.location.href = "{% url 'orders:order_success' 0 %}".replace("0", paymentIntent.id);
    }
  });
</script>
{% endblock %}
