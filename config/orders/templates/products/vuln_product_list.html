{% extends "base.html" %}
{% block title %}‚ö† Vulnerable Products{% endblock %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
<link rel="stylesheet" href="{% static 'css/alerts.css' %}">
{% endblock %}

{% block content %}

<!-- üî¥ Vulnerable Mode Banner (full-width above container) -->
<div class="vulnerable-alert">
    ‚ö†Ô∏è You are currently in <strong>VULNERABLE MODE</strong>.  
    Inputs are not validated and may expose security risks.
</div>

{# ---------------- CATEGORY SIDEBAR ---------------- #}
<div class="category-sidebar">
    <h3>Categories</h3>
    <ul>
        {% for category in categories %}
            <li>
              <a href="?category={{ category.slug }}">{{ category.name }}</a>
            </li>
        {% endfor %}
    </ul>
</div>

{# ---------------- PRODUCT GRID ---------------- #}
<div class="product-grid" aria-live="polite">
  {% if results %}
    {% for product in results %}
      <div class="product-card">

        {# ‚úÖ Product image logic with fallbacks #}
        {% if product.image_url %}
            <img src="{{ product.image_url }}" alt="{{ product.name }}">
        {% elif product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}">
        {% elif product.image_db %}
            <img src="{{ product.image_db }}" alt="{{ product.name }}">
        {% else %}
            {% if "smartphone" in product.name|lower %}
                <img src="{% static 'images/smartphone.jpg' %}" alt="{{ product.name }}">
            {% elif "laptop" in product.name|lower %}
                <img src="{% static 'images/laptop.jpg' %}" alt="{{ product.name }}">
            {% elif "t-shirt" in product.name|lower or "shirt" in product.name|lower %}
                <img src="{% static 'images/tshirt.jpg' %}" alt="{{ product.name }}">
            {% elif "jeans" in product.name|lower %}
                <img src="{% static 'images/jeans.jpg' %}" alt="{{ product.name }}">
            {% elif "python" in product.name|lower %}
                <img src="{% static 'images/python-programming.jpg' %}" alt="{{ product.name }}">
            {% elif "django" in product.name|lower %}
                <img src="{% static 'images/django-web.jpg' %}" alt="{{ product.name }}">
            {% else %}
                <img src="{% static 'images/dummy-product.jpg' %}" alt="{{ product.name }}">
            {% endif %}
        {% endif %}

        <h4>{{ product.name|default:"Unnamed" }}</h4>
        <p>${{ product.price }}</p>

        {% if product.slug %}
          <a href="{% url 'products:product_detail' product.slug %}">View</a>
        {% elif product.id %}
          <a href="{% url 'products:product_detail' product.id %}">View</a>
        {% endif %}

        {# Display reviews for this product #}
        <div class="product-reviews">
          <h5>Reviews:</h5>
          {% if reviews_by_product and reviews_by_product|get_item:product.id %}
            <ul>
              {% for review in reviews_by_product|get_item:product.id %}
                <li>
                  <strong>{{ review.user.username }}</strong>:
                  <em>{{ review.comment }}</em>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>No reviews yet.</p>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>No products found.</p>
  {% endif %}
</div>

{# ---------------- DIAGNOSTICS ---------------- #}
{% if raw_output %}
  <div class="diagnostics">
    <h4>üíª Command / SQL Output</h4>
    <pre>{{ raw_output }}</pre>
  </div>
{% endif %}

{% endblock %}
