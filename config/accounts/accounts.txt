# accounts/apps.py
from django.apps import AppConfig

class AccountsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "accounts"

    def ready(self):
        import accounts.signals


# accounts/forms
from django import forms
from django.contrib.auth.forms import UserCreationForm, AuthenticationForm
from .models import User

class RegistrationForm(UserCreationForm):
    email = forms.EmailField(required=True)

    class Meta:
        model = User
        fields = ("username", "email", "password1", "password2", "address", "phone")


class LoginForm(AuthenticationForm):
    pass


#accounts/models.py
from django.contrib.auth.models import AbstractUser
from django.db import models

class User(AbstractUser):
    phone = models.CharField(max_length=15, blank=True, null=True)
    address = models.TextField(blank=True, null=True)
    photo = models.ImageField(upload_to='profile_photos/', blank=True, null=True)  # ✅ new field


class UserProfile(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    mode = models.CharField(max_length=20, default="secure")  # "secure" or "vulnerable"

    def toggle_mode(self):
        self.mode = "vulnerable" if self.mode == "secure" else "secure"
        self.save()
        return self.mode


class VulnUser(models.Model):
    username = models.CharField(max_length=100)
    password = models.CharField(max_length=100)  # Stored in plain text!

    def __str__(self):
        return self.username


# accounts/signals.py
from django.db.models.signals import post_save
from django.dispatch import receiver
from django.contrib.auth.models import User
from .models import UserProfile

@receiver(post_save, sender=User)
def create_or_update_user_profile(sender, instance, created, **kwargs):
    if created:
        UserProfile.objects.create(user=instance)
    else:
        instance.userprofile.save()

@receiver(post_save, sender=User)
def save_user_profile(sender, instance, **kwargs):
    instance.profile.save()



#accounts/urls.py
from django.urls import path
from . import views
app_name = 'accounts'
urlpatterns = [
    path('vuln_login/', views.login_view, name='vuln_login'),
    path('vuln_register/', views.register_view, name='vuln_register'),
    path('lab/create_user/', views.create_lab_vuln_user, name='lab_create_user'),
    path('toggle_mode/', views.toggle_mode, name='toggle_mode'),
    path('login/', views.login_view, name='login'),
    path('register/', views.register_view, name='register'),
    path('logout/', views.logout_view, name='logout'),
    path('profile/', views.profile_view, name='profile'),
    # keep your existing secure routes as-is
]



# accounts/views.py
# LAB ONLY: intentionally vulnerable pieces for testing SQLi, XSS and brute-force.
# DO NOT DEPLOY THIS FILE OR ITS ROUTES TO PRODUCTION.

from django.shortcuts import render, redirect
from django.contrib.auth import login, logout, authenticate, get_user_model
from django.contrib import messages
from django.conf import settings
from django.db import connection
from django.http import JsonResponse, HttpResponse
from django.views.decorators.csrf import csrf_exempt
from django.contrib.auth.decorators import login_required
from django.urls import reverse
import logging

from .forms import RegistrationForm, LoginForm
from .models import VulnUser  # intentionally vulnerable user model for lab
from security_client import send_security_event  # integration to your logger/monitor

User = get_user_model()
logger = logging.getLogger(__name__)


def get_client_ip(request):
    x_forwarded_for = request.META.get("HTTP_X_FORWARDED_FOR")
    if x_forwarded_for:
        ip = x_forwarded_for.split(",")[0]
    else:
        ip = request.META.get("REMOTE_ADDR")
    return ip


def register_view(request):
    """
    Registration: in vulnerable mode we intentionally store plaintext to demonstrate weak storage.
    In secure mode we use the normal RegistrationForm which should create hashed passwords.
    """
    user_ip = get_client_ip(request)
    mode = request.session.get('sim_mode', 'secure')

    # VULNERABLE registration (plaintext storage) — lab only
    if mode == 'vulnerable' and getattr(settings, "VULNERABLE_LABS", {}).get("weak_password_hash", True):
        if request.method == 'POST':
            username = request.POST.get('username')
            password = request.POST.get('password')
            email = request.POST.get('email')
            # intentionally insecure: storing plaintext password (lab demo only)
            VulnUser.objects.create(username=username, password=password, email=email)
            messages.warning(request, "Registered (VULNERABLE): plaintext password stored.")
            send_security_event(f"Vulnerable Registration: username='{username}'", user_ip)
            return redirect('accounts:vuln_login')
        return render(request, 'accounts/vuln_register.html')

    # Secure registration (normal flow)
    if request.method == 'POST':
        form = RegistrationForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Registration successful. Please log in.")
            username = form.cleaned_data.get("username")
            send_security_event(f"Secure Registration: username='{username}'", user_ip)
            return redirect('accounts:login')
    else:
        form = RegistrationForm()
    return render(request, 'accounts/register.html', {'form': form})


def login_view(request):
    """
    Combined view: switches behavior based on session['sim_mode']:
      - vulnerable mode: intentionally unsafe (raw SQL concatenation, reflected username via template)
      - secure mode: use Django auth (authenticate + login)
    """
    user_ip = get_client_ip(request)
    mode = request.session.get('sim_mode', 'secure')

    # ---------- VULNERABLE MODE ----------
    if mode == 'vulnerable':
        attempted_username = None
        if request.method == 'POST':
            username = request.POST.get('username', '')
            password = request.POST.get('password', '')

            # Log event (lab)
            send_security_event(f"VULN LOGIN ATTEMPT: username='{username}'", user_ip)

            # keep the raw username to reflect back into template unsafely (demonstrate XSS)
            attempted_username = username

            # INTENTIONALLY VULNERABLE: raw SQL string concatenation (SQLi demo)
            # WARNING: This is for lab/test only.
            query = f"SELECT id FROM accounts_vulnuser WHERE username = '{username}' AND password = '{password}'"
            with connection.cursor() as cursor:
                cursor.execute(query)   # vulnerable to SQL injection
                row = cursor.fetchone()

            if row:
                # For demo convenience: log in a placeholder secure user (if exists),
                # otherwise just show a success message.
                try:
                    secure_user = User.objects.get(username="secure_user")
                    login(request, secure_user)
                    messages.success(request, "Logged in (vulnerable flow).")
                    return redirect('accounts:profile')
                except User.DoesNotExist:
                    messages.success(request, "Login succeeded (vulnerable flow).")
                    return redirect('home')
            else:
                messages.error(request, "Invalid credentials (vulnerable login).")
        # Render the vulnerable login template which intentionally echoes attempted_username unsafely
        return render(request, 'accounts/vuln_login.html', {"attempted_username": attempted_username})

    # ---------- SECURE MODE ----------
    # Use Django auth forms and normal protections
    if request.method == 'POST':
        form = LoginForm(data=request.POST)
        if form.is_valid():
            user = form.get_user()
            login(request, user)
            username = form.cleaned_data.get("username")
            send_security_event(f"Secure Login: username='{username}'", user_ip)
            return redirect('accounts:profile')
        else:
            messages.error(request, "Invalid username or password.")
    else:
        form = LoginForm()
    return render(request, 'accounts/login.html', {'form': form})


def logout_view(request):
    logout(request)
    return redirect('home')


@login_required
def profile_view(request):
    """
    Profile view — keeps your existing secure/vulnerable upload logic.
    Kept mostly as-is for lab.
    """
    mode = request.session.get("sim_mode", "secure")
    user = request.user
    user_ip = get_client_ip(request)

    if request.method == "POST":
        # updating address & phone allowed in both modes
        if "address" in request.POST:
            user.address = request.POST.get("address", "").strip()
        if "phone" in request.POST:
            user.phone = request.POST.get("phone", "").strip()

        uploaded_file = request.FILES.get("photo")

        if mode == "secure":
            # secure handling (validate size, extension, and Pillow verification)
            MAX_UPLOAD_SIZE = 2 * 1024 * 1024
            ALLOWED_IMAGE_EXTS = {"jpg", "jpeg", "png", "gif"}
            if uploaded_file:
                if uploaded_file.size > MAX_UPLOAD_SIZE:
                    messages.error(request, "File too large.")
                else:
                    ext = uploaded_file.name.rsplit('.', 1)[-1].lower() if '.' in uploaded_file.name else ''
                    if ext not in ALLOWED_IMAGE_EXTS:
                        messages.error(request, "Extension not allowed.")
                    else:
                        from io import BytesIO
                        from PIL import Image, UnidentifiedImageError
                        from django.core.files.base import ContentFile
                        import uuid, os
                        content = uploaded_file.read()
                        try:
                            Image.open(BytesIO(content)).verify()
                        except (UnidentifiedImageError, Exception):
                            messages.error(request, "Uploaded file is not a valid image.")
                        else:
                            safe_filename = f"{uuid.uuid4().hex}.{ext}"
                            saved_path = default_storage.save(os.path.join("profile_photos", safe_filename), ContentFile(content))
                            user.photo = saved_path
                            user.save()
                            messages.success(request, "Profile updated (secure).")
            else:
                user.save()
            send_security_event(f"Secure Profile Update by user={user.username}", user_ip)

        else:
            # Vulnerable mode: intentionally skip validation and save with original filename
            if uploaded_file:
                content = uploaded_file.read()
                saved_path = default_storage.save(os.path.join("profile_photos", uploaded_file.name), ContentFile(content))
                user.photo = saved_path
                messages.warning(request, "Profile photo uploaded (VULNERABLE MODE).")
            user.save()
            send_security_event(f"Vulnerable Profile Update by user={user.username}", user_ip)

        return redirect("accounts:profile")

    context = {"mode": mode}
    if mode == "secure":
        context["allowed_exts"] = sorted({"jpg", "jpeg", "png", "gif"})
    return render(request, "accounts/profile.html", context)


# ---------- LAB HELPERS ----------

def create_lab_vuln_user(request):
    """
    Helper endpoint to create a lab vulnerable user (plaintext password) quickly.
    Usage: GET /accounts/lab/create_user/  (call from local browser)
    WARNING: only intended for dev/lab environments.
    """
    if not settings.DEBUG:
        return HttpResponse("Not allowed", status=403)

    username = "lab_test_user"
    password = "labpass123"
    email = "lab@example.local"
    # Create or update a VulnUser row
    obj, created = VulnUser.objects.update_or_create(
        username=username,
        defaults={"password": password, "email": email}
    )
    return JsonResponse({"created": created, "username": username, "password": password})


def toggle_mode(request):
    """
    Toggle sim_mode between 'secure' and 'vulnerable' (session-level).
    Use this to switch the app behavior at runtime from a browser.
    """
    current_mode = request.session.get('sim_mode', 'secure')
    new_mode = 'vulnerable' if current_mode == 'secure' else 'secure'
    request.session['sim_mode'] = new_mode
    request.session.save()
    logger.info(f"Toggled mode from {current_mode} to {new_mode}")
    return JsonResponse({"mode": new_mode})


#accounts/templates

#profile.html
{% extends "base.html" %}

{% block title %}Profile{% endblock %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="form-container">
  <h2>Welcome, {{ user.username }}</h2>
  <p>Email: {{ user.email }}</p>

  <!-- current profile photo -->
  {% if user.photo %}
    <img id="currentPhoto" src="{{ user.photo.url }}" alt="Profile Photo">
  {% else %}
    <p>No profile photo uploaded.</p>
  {% endif %}

  <!-- Mode banner -->
  {% if mode == "vulnerable" %}
    <div class="mode-banner vulnerable">
      <strong>⚠️ VULNERABLE MODE</strong> — Upload validation intentionally disabled for lab/demo only. <em>Do not use on a public server.</em>
    </div>
  {% else %}
    <div class="mode-banner secure">
      <strong>Secure mode</strong> — uploads are validated. Allowed extensions:
      <code>{{ allowed_exts|join:", " }}</code>. Max size: 2 MB.
    </div>
  {% endif %}

  <!-- Messages -->
  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- Upload + profile form -->
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Image preview (client-side) -->
    <img id="photoPreview" src="" alt="Preview" style="display:none; width:150px; height:150px; object-fit:cover; border-radius:8px; margin:8px 0;">

    <div id="fileInfo" class="helper" style="display:none;"></div>

    <label for="photo">Profile Photo:</label><br>
    <input
      type="file"
      id="photoInput"
      name="photo"
      accept="image/*"
      {% if mode == "secure" and allowed_exts %}
        data-allowed-exts="{{ allowed_exts|join:',' }}"
        data-max-bytes="2097152"
      {% endif %}
    ><br><br>

    <label for="address">Address:</label><br>
    <textarea name="address" rows="3" cols="40">{{ user.address }}</textarea><br><br>

    <label for="phone">Phone:</label><br>
    <input type="text" name="phone" value="{{ user.phone }}"><br><br>

    <button type="submit">Update Profile</button>
  </form>
</div>

<!-- Client-side preview + simple validation script -->
<script>
(() => {
  const input = document.getElementById('photoInput');
  const preview = document.getElementById('photoPreview');
  const info = document.getElementById('fileInfo');
  if (!input) return;

  const allowedExtsAttr = input.dataset.allowedExts || "";
  const allowedExts = allowedExtsAttr ? allowedExtsAttr.split(',').map(e => e.trim().toLowerCase()) : null;
  const maxBytes = input.dataset.maxBytes ? parseInt(input.dataset.maxBytes, 10) : null;

  input.addEventListener('change', (ev) => {
    const file = ev.target.files && ev.target.files[0];
    if (!file) {
      preview.style.display = 'none';
      info.style.display = 'none';
      preview.src = '';
      return;
    }

    const filename = file.name;
    const sizeKB = Math.round(file.size / 1024);
    const ext = filename.split('.').pop().toLowerCase();

    if (allowedExts) {
      // secure mode client-side checks
      if (!allowedExts.includes(ext)) {
        info.style.display = 'block';
        info.textContent = `Extension '.${ext}' not allowed. Allowed: ${allowedExts.join(', ')}.`;
        info.style.color = '#7f1d1d';
        preview.style.display = 'none';
        preview.src = '';
        return;
      }
      if (maxBytes && file.size > maxBytes) {
        info.style.display = 'block';
        info.textContent = `File too large (${sizeKB} KB). Max ${(maxBytes/1024/1024).toFixed(1)} MB.`;
        info.style.color = '#7f1d1d';
        preview.style.display = 'none';
        preview.src = '';
        return;
      }
    } else {
      // vulnerable mode: show warning
      info.style.display = 'block';
      info.textContent = '⚠️ VULNERABLE MODE: client-side validation is disabled. This upload is intentionally unsafe.';
      info.style.color = '#92400e';
    }

    // show preview
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);

    if (allowedExts) {
      info.style.display = 'block';
      info.textContent = `${filename} — ${sizeKB} KB`;
      info.style.color = '#065f46';
    } else {
      info.textContent += `  •  ${filename} — ${sizeKB} KB`;
    }
  });
})();
</script>
{% endblock %}


#login.html
{% extends "base.html" %}

{% block title %}Login{% endblock %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/login.css' %}">
{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Login </h2>
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Login</button>
    </form>
</div>
{% endblock %}


#register.html

{% extends "base.html" %}
{% block title %}Register{% endblock %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/register.css' %}">
{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Register</h2>

    {% if registered %}
        <div class="register-success">
            Registration complete! You can now
            <a href="{% url 'accounts:login' %}">login here</a>.
        </div>
    {% else %}
        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Register</button>
        </form>
    {% endif %}
</div>
{% endblock %}


#vuln_login.html

{% extends 'base.html' %}
{% load static %}

{% block title %}Vulnerable Login{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/vuln_login.css' %}">
{% endblock %}
{% block content %}
<div class="login-container">
    <h2>Vulnerable Login Lab</h2>
    <p class="lab-note">LAB MODE — intentionally vulnerable. Do not deploy.</p>

    <p>Try SQL injection to bypass login (example shown for demo only): <code>' OR '1'='1' --</code></p>

    <form method="POST">
        {% csrf_token %}
        <label>Username:</label>
        <input type="text" name="username" placeholder="Enter username" required>

        <label>Password:</label>
        <!-- text type to make password visible for demo purposes -->
        <input type="text" name="password" placeholder="Enter password" required>

        <button type="submit">Login</button>
    </form>

    <!-- Unsafe echo to demonstrate reflected XSS (LAB ONLY) -->
    {% if attempted_username %}
        <div class="last-attempt">
            <strong>Last attempt (reflected unsafely):</strong>
            <!-- WARNING: intentionally unsafe for demo -->
            {{ attempted_username|safe }}
        </div>
    {% endif %}

    <p><a href="{% url 'accounts:register' %}">Go to Vulnerable Registration</a></p>

    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <p class="{{ message.tags }}">{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}
</div>
{% endblock %}


#vuln_register.html

{% extends 'base.html' %}
{% load static %}

{% block title %}Vulnerable Registration{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/vuln_register.css' %}">
{% endblock %}

{% block content %}
<div class="login-container">
    <h2>Vulnerable Registration Lab</h2>
    <p>Passwords are stored in plain text for this lab (DON'T use in real life!)</p>

    <form method="POST">
        {% csrf_token %}
        <label>Username:</label>
        <input type="text" name="username" placeholder="Enter username" required>

        <label>Email:</label>
        <input type="email" name="email" placeholder="Enter email" required>

        <label>Password:</label>
        <input type="text" name="password" placeholder="Enter password" required>

        <button type="submit">Register</button>
    </form>

    <p><a href="{% url 'accounts:login' %}">Go to Vulnerable Login</a></p>

    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <p class="{{ message.tags }}">{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}
</div>
{% endblock %}










