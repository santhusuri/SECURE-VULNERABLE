{% extends "base.html" %}
{% load static %}

{% block title %}Profile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
<style>
  .mode-banner.secure {
    background:#ecfdf5;
    border:1px solid #10b981;
    color:#065f46;
    padding:10px;
    border-radius:6px;
    margin-bottom:1rem;
  }
  .mode-banner.vulnerable {
    background:#fef2f2;
    border:1px solid #dc2626;
    color:#991b1b;
    padding:10px;
    border-radius:6px;
    margin-bottom:1rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="form-container" style="max-width:700px;margin:2rem auto;padding:1.5rem;border:1px solid #e5e7eb;border-radius:8px;background:#fff;">
  <h2>üë§ Welcome, {{ user.username }}</h2>
  <p>Email: {{ user.email }}</p>

  <!-- Current Profile Photo -->
  {% if user.photo %}
    <img id="currentPhoto" src="{{ user.photo.url }}" alt="Profile Photo"
         style="max-width:150px;max-height:150px;border-radius:8px;margin-top:10px;">
  {% else %}
    <p>No profile photo uploaded.</p>
  {% endif %}

  <!-- Mode Banner -->
  {% if mode == "vulnerable" %}
    <div class="mode-banner vulnerable">
      ‚ö† <strong>VULNERABLE MODE</strong> ‚Äî Upload validation is intentionally disabled. 
      <em>This demonstrates risks such as unrestricted file uploads and XSS.</em>
    </div>
  {% else %}
    <div class="mode-banner secure">
      üõ° <strong>Secure Mode</strong> ‚Äî uploads are validated.  
      Allowed: <code>{{ allowed_exts|join:", " }}</code> ‚Ä¢ Max size: 2 MB.
    </div>
  {% endif %}

  <!-- Messages -->
  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- Update Profile Form -->
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Image preview -->
    <img id="photoPreview" src="" alt="Preview"
         style="display:none;width:150px;height:150px;object-fit:cover;border-radius:8px;margin:8px 0;">

    <div id="fileInfo" class="helper" style="display:none;font-size:.9rem;"></div>

    <label for="photo">Profile Photo:</label><br>
    <input type="file" id="photoInput" name="photo" accept="image/*"
      {% if mode == "secure" and allowed_exts %}
        data-allowed-exts="{{ allowed_exts|join:',' }}"
        data-max-bytes="2097152"
      {% endif %}
    ><br><br>

    <label for="address">Address:</label><br>
    <textarea name="address" rows="3" cols="40">{{ user.address }}</textarea><br><br>

    <label for="phone">Phone:</label><br>
    <input type="text" name="phone" value="{{ user.phone }}"><br><br>

    <button type="submit" style="background:#2563eb;color:white;padding:.6rem 1rem;border:none;border-radius:6px;cursor:pointer;">
      Update Profile
    </button>
  </form>
</div>

<!-- Client-side Preview + Validation -->
<script>
(() => {
  const input = document.getElementById('photoInput');
  const preview = document.getElementById('photoPreview');
  const info = document.getElementById('fileInfo');
  if (!input) return;

  const allowedExtsAttr = input.dataset.allowedExts || "";
  const allowedExts = allowedExtsAttr ? allowedExtsAttr.split(',').map(e => e.trim().toLowerCase()) : null;
  const maxBytes = input.dataset.maxBytes ? parseInt(input.dataset.maxBytes, 10) : null;

  input.addEventListener('change', (ev) => {
    const file = ev.target.files && ev.target.files[0];
    if (!file) {
      preview.style.display = 'none';
      info.style.display = 'none';
      preview.src = '';
      return;
    }

    const filename = file.name;
    const sizeKB = Math.round(file.size / 1024);
    const ext = filename.split('.').pop().toLowerCase();

    if (allowedExts) {
      if (!allowedExts.includes(ext)) {
        info.textContent = `‚ùå Extension ".${ext}" not allowed. Allowed: ${allowedExts.join(', ')}.`;
        info.style.color = '#b91c1c';
        preview.style.display = 'none';
        return;
      }
      if (maxBytes && file.size > maxBytes) {
        info.textContent = `‚ùå File too large (${sizeKB} KB). Max ${(maxBytes/1024/1024).toFixed(1)} MB.`;
        info.style.color = '#b91c1c';
        preview.style.display = 'none';
        return;
      }
      info.textContent = `‚úÖ ${filename} ‚Äî ${sizeKB} KB`;
      info.style.color = '#065f46';
    } else {
      info.textContent = `‚ö†Ô∏è Vulnerable mode: no validation. File = ${filename} (${sizeKB} KB)`;
      info.style.color = '#92400e';
    }

    info.style.display = 'block';

    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });
})();
</script>
{% endblock %}
